<!DOCTYPE html>
<html>
	<head>
		<link rel='stylesheet' href='/static/css/main.css' />
		<link rel='stylesheet' href='/static/css/visualize.css' />
		<link rel='stylesheet' href='/static/css/visualize-light.css' />
		<link rel='stylesheet' href='/static/css/jquery-ui-1.10.2.custom.min.css' />
		<script src="/static/js/jquery-1.9.1.min.js" ></script>
		<script src="/static/js/jquery-ui-1.10.2.custom.min.js" ></script>
		<script src="/static/js/visualize.jQuery.js" ></script>
		<script src="/static/js/knockout-2.2.1.js" ></script>
	</head>
	<title>Wypadki drogowe</title>
	<body>
		<header>
			<h1>Wypadki drogowe</h1>
		</header>
		<div id="container">
			<div id="tables" style="float:left;" class="dash_container">
			<form id="dates_form">
				<fieldset  style="float:left;">
					<legend>Daty od-do</legend>
				<input type="text" id="date_from" data-bind="value: date_from"/>
				<input type="text" id="date_to" data-bind="value: date_to"/>
				</fieldset>
				<fieldset style="float:left;">
					<legend>Granulacja</legend>
					<label><input type="radio" name="granularity" value="daily" data-bind="checked: date_granularity"/>Dziennie</label>
					<br/>
					<label><input type="radio" name="granularity" value="monthly" data-bind="checked: date_granularity"/>Miesiecznie</label>
					<br />
					<label><input type="radio" name="granularity" value="quarterly" data-bind="checked: date_granularity"/>Kwartalnie</label>
					<br/>
					<label><input type="radio" name="granularity" value="yearly" data-bind="checked: date_granularity"/>Rocznie</label>
				</fieldset>
			</form>
			<fieldset>
				<legend>Dane</legend>
				<table id="data_table">
					<thead>

					</thead>
					<tbody>
						
					</tbody>
				</table>
			</fieldset>
			</div>
			<div id="graph" style="float:left;" class="dash_container">
				<fieldset>
					<legend>Wykres</legend>
					<div id="graph_data"></div>
				</fieldset>
			</div>
			<div id="config" style="float:left;" class="dash_container">
				<form id="config_form">
					<fieldset>
						<legend>Konfiguracja</legend>
						<h3>Województwa</h3>
						<div data-bind="foreach: regions">
							<input type="checkbox" data-bind="value: $$data.id, checked: $$root.selected_regions, attr: {id: 'region_'+$$data.id}" />
							<label data-bind="text: $$data.name, attr: {for: 'region_'+$$data.id}"></label>
							<br/>
						</div>
						<br />
						Warunki:
						<div id="conditions" data-bind="foreach: conditions">
							<input type="radio" name="condition" data-bind="checked: $$root.selected_condition, value: $$data, attr: {id: $$data}" /><label data-bind="text: $$data, attr: {for: $$data}"></label><br/>
						</div>
						<br/>
						
						
						<input type="button" id="refresh_button" value="Odśwież" data-bind="click: refreshView"/>
					</fieldset>
				</form>
			</div>
		</div>
		<footer>
			Zaawansowane techniki integracji systemów
		</footer>
	<script type="text/html" id="person-template">
    	<h3 data-bind="text: name"></h3>
    	<p>Credits: <span data-bind="text: credits"></span></p>
	</script>
	<script type="text/javascript">
		$$(document).ready(function(){
			
			function AppViewModel() {
				var self = this;
				
				//table
				//self.dates = ko.observableArray();
				//self.rows = ko.observableArray();
				
				self.date_granularity = ko.observable("monthly");
				self.date_from = ko.observable('2008-04-01');
				self.date_to = ko.observable('2013-04-15');
				self.selected_regions = ko.observableArray();
				self.selected_condition = ko.observable();
				//Dummy data
				self.cities = ['katowice','rzeszow'];
				self.conditions = ko.observableArray([['pogoda','min_temp'],['pogoda','max_temp'],['pogoda','cisnienie']]);
				
				self.regions = ko.observableArray();
				
				//Behaviour
				self.refreshView = function() {
					console.log("selected_regions: "+self.selected_regions());
					$$.ajax({
							url: '/get_data',
							dataType: 'json',
							data: { 
									json: ko.toJSON({
										date_from: self.date_from(),
										date_to: self.date_to(),
										regions: self.selected_regions(),
										selected_condition: self.selected_condition(),
										granularity: self.date_granularity()
									}) 
								}
					}).done(function(data){
						var rows = data['rows'];
						
						var head = $$('#data_table > thead');
						head.html('');
						head.append('<tr>');
						var head_tr = $$(head.children()[0]);
						head_tr.append('<td>');
						
						var tbody = $$('#data_table > tbody');
						tbody.html('');
						var done = {}						
						for(var i=0;i<rows.length;i++){
							var row=rows[i];
							var region = row[0]
							var date_objs = row[1];
							if(i==0){
								for(var date in date_objs){
									var th = $$('<th>')
									th.html(date)
									head_tr.append(th)
								}
							}
							var tr = $$('<tr>')
							var name = $$('<th>')
							name.html(region)
							tr.append(name)
							for(var date in date_objs){
								var td = $$('<td>')
								td.html(date_objs[date].wypadki)
								tr.append(td);
							}
							tbody.append(tr)
						}
						
						//$$('#data_table').visualize({type:'line'});
						$$('#graph_data').html('');
						$$('#data_table').visualize({type:'bar'}).appendTo('#graph_data');
						$$('#data_table').visualize({type:'line'}).appendTo('#graph_data');
					})
				}
				
				$$.getJSON('/get_regions').done(function(data){
					self.regions(data);
				})
				
			}
			
			
			ko.applyBindings(new AppViewModel());
			
			$$('#date_from').datepicker({dateFormat:"yy-mm-dd"});
			$$('#date_to').datepicker({dateFormat:"yy-mm-dd"});
			
			//visuals
			$$('#refresh_button').button();
			$$('#city').menu();
		});
	</script>
	</body>
</html>